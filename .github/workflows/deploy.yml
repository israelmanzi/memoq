name: Build and Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'docker-compose.yml'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'tsconfig.json'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @oxy/shared build

      - name: Type check
        run: pnpm typecheck

      - name: Lint
        run: pnpm lint

      - name: Build
        run: pnpm build

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          PROJECT_DIR: ${{ secrets.PROJECT_DIR }}
          API_PORT: ${{ secrets.API_PORT }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: PROJECT_DIR,API_PORT
          command_timeout: 15m
          script: |
            # Exit on error, but handle rollback manually
            cd "$PROJECT_DIR" || exit 1

            # Store current state for rollback
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            echo "=== Deployment started at $TIMESTAMP ==="
            echo "Current commit: $PREVIOUS_COMMIT"

            # Tag current images for rollback
            echo "=== Tagging current images for rollback ==="
            docker tag memoq-api:latest memoq-api:rollback 2>/dev/null || true
            docker tag memoq-web:latest memoq-web:rollback 2>/dev/null || true
            docker tag memoq-worker:latest memoq-worker:rollback 2>/dev/null || true

            # Pull latest code
            echo "=== Pulling latest changes ==="
            git fetch origin main
            git reset --hard origin/main

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "New commit: $NEW_COMMIT"

            if [ "$PREVIOUS_COMMIT" = "$NEW_COMMIT" ]; then
              echo "No changes to deploy. Exiting."
              exit 0
            fi

            # Build new images
            echo "=== Building new images ==="
            if ! docker compose build; then
              echo "Build failed! No changes made to running services."
              git reset --hard "$PREVIOUS_COMMIT"
              exit 1
            fi

            # Stop and restart with new images
            echo "=== Restarting services ==="
            docker compose down --timeout 30

            if ! docker compose up -d; then
              echo "=== FAILED: Starting new containers ==="
              echo "=== Rolling back to previous version ==="
              git reset --hard "$PREVIOUS_COMMIT"
              docker tag memoq-api:rollback memoq-api:latest 2>/dev/null || true
              docker tag memoq-web:rollback memoq-web:latest 2>/dev/null || true
              docker tag memoq-worker:rollback memoq-worker:rollback 2>/dev/null || true
              docker compose up -d
              echo "Rollback complete."
              exit 1
            fi

            # Wait for health checks
            echo "=== Waiting for services to be healthy ==="
            RETRIES=30
            while [ $RETRIES -gt 0 ]; do
              if curl -sf "http://127.0.0.1:${API_PORT:-5064}/health" > /dev/null 2>&1; then
                echo "API is healthy!"
                break
              fi
              echo "Waiting for API... ($RETRIES retries left)"
              sleep 5
              RETRIES=$((RETRIES - 1))
            done

            if [ $RETRIES -eq 0 ]; then
              echo "=== FAILED: API health check ==="
              echo "=== Rolling back to previous version ==="
              docker compose down --timeout 30
              git reset --hard "$PREVIOUS_COMMIT"
              docker tag memoq-api:rollback memoq-api:latest 2>/dev/null || true
              docker tag memoq-web:rollback memoq-web:latest 2>/dev/null || true
              docker tag memoq-worker:rollback memoq-worker:rollback 2>/dev/null || true
              docker compose up -d
              echo "Rollback complete."
              exit 1
            fi

            # Run migrations
            echo "=== Running database migrations ==="
            docker compose exec -T api node dist/db/migrate.js || echo "Migration warning (may be ok)"

            # Cleanup old images (only from this project)
            echo "=== Cleaning up old images ==="
            docker rmi memoq-api:rollback memoq-web:rollback memoq-worker:rollback 2>/dev/null || true
            docker image prune -f --filter "label=com.docker.compose.project=memoq" 2>/dev/null || true

            echo "=== Deployment successful! ==="
            echo "Previous: $PREVIOUS_COMMIT"
            echo "Deployed: $NEW_COMMIT"
            docker compose ps
